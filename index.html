<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semillas & Snacks | Pedidos</title>
    <style>
        /* ESTILOS (Dise√±o visual) */
        :root { --primary: #4a5d4e; --bg: #faf9f6; --border: #ddd; }
        body { font-family: 'Helvetica', sans-serif; background: var(--bg); color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* ENCABEZADO */
        header { 
            display: flex; align-items: center; justify-content: flex-start; 
            gap: 20px; text-align: left; margin-bottom: 30px; 
            padding-bottom: 20px; border-bottom: 1px solid #eee; 
        }
        .logo { width: 100px; height: auto; border-radius: 8px; object-fit: cover; }
        h1 { color: var(--primary); margin-bottom: 5px; }

        @media (max-width: 600px) { header { flex-direction: column; text-align: center; } }
        
        /* TABLA Y FORMULARIO */
        .product-table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
        .product-table th { text-align: left; padding: 12px; border-bottom: 2px solid var(--primary); color: var(--primary); }
        .product-table td { padding: 15px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .qty-input { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        .add-btn { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .order-section { background: #fdfdfd; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        input[type="text"], input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .main-btn { width: 100%; padding: 15px; background: #28a745; color: white; border: none; font-size: 1.1em; cursor: pointer; border-radius: 5px; margin-top: 10px; }
        
        #status-message { margin-top: 15px; text-align: center; padding: 10px; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <img src="logo.png" alt="Logo" class="logo">
        
        <div>
            <h1 style="margin:0; font-size: 1.8em;">Semillas & Snacks</h1>
            <p style="margin:5px 0 0 0; color: #666;">Cat√°logo de Mayoreo</p>
        </div>
    </header>

    <div id="loading" style="text-align:center; color:#888;">Cargando lista...</div>
    
    <table class="product-table">
        <thead>
            <tr>
                <th width="50%">Producto</th>
                <th width="20%">Precio</th>
                <th width="15%">Cant.</th>
                <th width="15%">Acci√≥n</th>
            </tr>
        </thead>
        <tbody id="product-list-body"></tbody>
    </table>

    <form id="order-form" class="order-section" onsubmit="sendOrder(event)">
        <h2>üõí Resumen del Pedido</h2>
        <div id="cart-content" style="color: #666; font-style: italic; margin-bottom: 15px;">A√∫n no has agregado productos.</div>
        <p style="text-align: right; font-size: 1.3em;">Total: <strong>$<span id="total-display">0.00</span></strong></p>
        <hr>
        <div class="form-group"><input type="text" id="nombre" placeholder="Nombre completo" required></div>
        <div class="form-group"><input type="text" id="direccion" placeholder="Direcci√≥n de entrega" required></div>
        <div class="form-group"><label>Fecha de entrega:</label><input type="date" id="fecha" required></div>
        <button type="submit" id="submit-btn" class="main-btn">Confirmar Pedido</button>
        <div id="status-message"></div>
    </form>
</div>

<script>
    // --- CONFIGURACI√ìN ---
    // PEGA AQU√ç TUS ENLACES REALES (Si no, saldr√°n productos de prueba)
    const scriptURL = 'TU_URL_LARGA_DE_APPS_SCRIPT_AQUI'; 
    const hojaCSV = 'TU_ENLACE_CSV_GOOGLE_SHEETS'; 

    const datosPrueba = [
        {nombre: "Mix de semillas (45 gr)", precio: 16, descripcion: "Semillas y ar√°ndano"},
        {nombre: "Pistaches (40 gr)", precio: 16, descripcion: "Horneados con sal"},
        {nombre: "Ar√°ndanos (40 g)", precio: 12, descripcion: "Deshidratados"},
        {nombre: "Mango (40 g)", precio: 95, descripcion: "Enchilado"},
        {nombre: "Fresa (40 g)", precio: 30, descripcion: "Natural"}
    ];

    let globalProducts = [];
    let cart = [];

    window.onload = async function() {
        if(hojaCSV === 'TU_ENLACE_CSV_GOOGLE_SHEETS' || hojaCSV === '') {
            globalProducts = datosPrueba; renderTable(globalProducts);
        } else {
            try {
                const response = await fetch(hojaCSV);
                const data = await response.text();
                globalProducts = parseCSV(data);
                renderTable(globalProducts);
            } catch (err) {
                console.error(err);
                globalProducts = datosPrueba; renderTable(globalProducts);
            }
        }
    };

    function parseCSV(csvText) {
        const lines = csvText.split('\n');
        const products = [];
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line) {
                const parts = line.split(','); 
                if(parts.length >= 2) products.push({ nombre: parts[0], precio: parseFloat(parts[1]), descripcion: parts[2] || '' });
            }
        }
        return products;
    }

    function renderTable(list) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('product-list-body').innerHTML = list.map((p, index) => `
            <tr>
                <td><strong>${p.nombre}</strong><br><small style="color:#777;">${p.descripcion}</small></td>
                <td>$${p.precio}</td>
                <td><input type="number" id="qty-${index}" class="qty-input" value="1" min="1"></td>
                <td><button class="add-btn" onclick="addToCart(${index})">Agregar</button></td>
            </tr>`).join('');
    }

    function calcularPrecioFinal(nombre, precioBase, cantidad) {
        if (nombre.toLowerCase().includes("pistache") && cantidad >= 20) {
            return { precioUnitario: precioBase * (1 - 0.094), tieneDescuento: true };
        }
        return { precioUnitario: precioBase, tieneDescuento: false };
    }

    function addToCart(index) {
        const product = globalProducts[index];
        const qty = parseInt(document.getElementById(`qty-${index}`).value);
        if(qty < 1) return;

        const existIdx = cart.findIndex(item => item.name === product.nombre);
        if(existIdx !== -1) {
            cart[existIdx].qty += qty;
            const calc = calcularPrecioFinal(product.nombre, product.precio, cart[existIdx].qty);
            cart[existIdx].unitPrice = calc.precioUnitario;
            cart[existIdx].discounted = calc.tieneDescuento;
            cart[existIdx].subtotal = cart[existIdx].qty * calc.precioUnitario;
        } else {
            const calc = calcularPrecioFinal(product.nombre, product.precio, qty);
            cart.push({ name: product.nombre, unitPrice: calc.precioUnitario, qty: qty, subtotal: qty * calc.precioUnitario, discounted: calc.tieneDescuento });
        }
        document.getElementById(`qty-${index}`).value = 1;
        updateCartUI();
    }

    function updateCartUI() {
        const list = document.getElementById('cart-content');
        if(cart.length === 0) { list.innerHTML = "Carrito vac√≠o"; document.getElementById('total-display').innerText = "0.00"; return; }
        
        let total = 0;
        let html = '<ul style="padding-left:20px;">';
        cart.forEach((item, idx) => {
            total += item.subtotal;
            const desc = item.discounted ? '<span style="color:green;font-size:0.8em">(Desc. Mayoreo)</span>' : '';
            html += `<li>${item.name} (x${item.qty}) - $${item.subtotal.toFixed(2)} ${desc} <a href="#" onclick="cart.splice(${idx},1);updateCartUI()" style="color:red">[x]</a></li>`;
        });
        list.innerHTML = html + '</ul>';
        document.getElementById('total-display').innerText = total.toFixed(2);
    }

    function sendOrder(e) {
        e.preventDefault();
        if(cart.length === 0) return alert("Carrito vac√≠o");
        
        const btn = document.getElementById('submit-btn');
        const msg = document.getElementById('status-message');
        btn.disabled = true; btn.innerText = "Enviando...";
        
        const data = {
            nombre: document.getElementById('nombre').value,
            direccion: document.getElementById('direccion').value,
            fechaEntrega: document.getElementById('fecha').value,
            items: cart.map(i => `${i.name} (x${i.qty})`).join(", "),
            total: document.getElementById('total-display').innerText
        };

        fetch(scriptURL, { method: 'POST', body: JSON.stringify(data) })
        .then(() => {
            msg.innerText = "‚úÖ ¬°Pedido Enviado!"; msg.className = "success"; msg.style.display = "block";
            cart = []; updateCartUI(); document.getElementById('order-form').reset();
            btn.innerText = "Confirmar Pedido"; btn.disabled = false;
        })
        .catch(() => {
            msg.innerText = "‚ùå Error de conexi√≥n"; msg.className = "error"; msg.style.display = "block";
            btn.disabled = false;
        });
    }
</script>
</body>
</html>
